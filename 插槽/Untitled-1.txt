<link href="http://eip.unisoc.com/sites/howto/WB0R5L90S/Static_Full_Version/font-awesome/css/font-awesome.css"
    rel="stylesheet">
<link href="http://eip.unisoc.com/sites/howto/WB0R5L90S/Static_Full_Version/css/plugins/iCheck/custom.css"
    rel="stylesheet">
<link href="http://eip.unisoc.com/sites/howto/WB0R5L90S/Static_Full_Version/css/animate.css" rel="stylesheet">
<link href="http://eip.unisoc.com/sites/howto/WB0R5L90S/Static_Full_Version/css/style.css" rel="stylesheet">
<link href="http://eip.unisoc.com/sites/howto/_catalogs/masterpage/jquery-ui-1.12.1/QRE/css/qre_common.css"
    rel="stylesheet" type="text/css">
<link
    href="http://eip.unisoc.com/sites/howto/_catalogs/masterpage/kendoUI/2017.3.1026/styles/kendo.common-material.min.css"
    rel="stylesheet" />
<link href="http://eip.unisoc.com/sites/howto/_catalogs/masterpage/kendoUI/2017.3.1026/styles/kendo.rtl.min.css"
    rel="stylesheet" />
<link href="http://eip.unisoc.com/sites/howto/_catalogs/masterpage/kendoUI/2017.3.1026/styles/kendo.material.min.css"
    rel="stylesheet" />
<link
    href="http://eip.unisoc.com/sites/howto/_catalogs/masterpage/kendoUI/2017.3.1026/styles/kendo.material.mobile.min.css"
    rel="stylesheet" />
<link rel="stylesheet"
    href="http://eip.unisoc.com/sites/howto/_catalogs/masterpage/jquery-ui-1.12.1/Select2/css/select2.min.css">

<style>
    /*QRE style*/
    .box {
        margin: 1.5em 1.5em !important;
        padding: 3em;
        background-color: rgba(20, 53, 80, 0.038);
        border: 1px solid rgba(20, 53, 80, 0.05);
    }

    table thead th a,
    table thead th span {
        text-transform: capitalize !important;
    }

    a:visited {
        color: #5f544e;
    }

    .k-grid .k-button {
        margin: 0 .03em;
    }

    h4 span {
        margin-right: 100px
    }

    /*上传文件样式*/
    #uploadFile,
    #uploadNewFile {
        position: relative;
    }

    #uploadFile input,
    #uploadNewFile input {
        position: absolute;
        font-size: 100px;
        right: 0;
        top: 0;
        opacity: 0;
        cursor: pointer;
    }

    .container-fluid .row:first-child {
        background: rgb(181, 130, 179);
    }

    /*最上边一行段落*/
    .ms-rtestate-field [role="textbox"]>p {
        display: none;
    }

    #s4-titlerow {
        display: block !important;
    }

    .ms-rte-layoutszone-outer {
        background: #fff;
    }

    /*kendo Table style*/
    /*表头背景色*/
    .k-block,
    .k-draghandle,
    .k-grid-header,
    .k-grouping-header,
    .k-header,
    .k-pager-wrap,
    .k-treemap-tile,
    html .km-pane-wrapper .k-header {
        background-color: rgba(181, 130, 179, 1) !important;
    }

    /*表头字体*/
    .k-grid-header .k-header,
    .k-grid-header .k-header .k-link,
    .k-grid-header .k-link,
    .k-grid-header .k-link:link,
    .k-pager-info,
    .k-scheduler-agendaview .k-scheduler-datecolumn,
    .k-scheduler-header {
        color: #fff;
        font-weight: 600 !important;
    }

    /*分组栏样式*/
    .k-grouping-header .k-group-indicator,
    .k-pivot-toolbar .k-button {
        color: #fff;
        background-color: rgba(181, 130, 179, 1);
        border-color: rgba(181, 130, 179, 1);
    }

    /*去掉边框*/
    .k-grid-header th.k-header {
        border: none;
        border-right: 1px solid #ccc;
    }

    /*分页栏样式*/
    .k-pager-wrap .k-link {
        border: none;
        color: #fff !important;
    }

    /*翻页栏样式*/
    .k-pager-numbers .k-state-selected {
        border-color: rgba(181, 130, 179, 1) transparent transparent;
        font-size: 11px;
    }

    /*自定义按钮大小*/
    .k-button {
        padding: 8px;
        font-size: 12px;
    }

    /*过滤样式*/
    .k-grid-filter.k-state-active {
        background-color: rgba(181, 130, 179, 1);
        color: #000;
    }

    .k-header-column-menu.k-state-active {
        background-color: #984394;
        border-radius: 50%;
        border-color: #984394;
    }

    /*自定义wrapper样式*/
    .mail-box {
        margin-bottom: 0;
    }

    .wrapper-content {
        padding: 28px 10px;
    }

    #page-wrapper {
        min-height: 294px;
    }

    /*select2 自定义样式*/
    #select2-product-results {
        background-color: rgba(181, 130, 179, 1);
        color: #fff;
    }

    .select2-container--default .select2-results__option[aria-selected=true] {
        background-color: #984394;
    }

    .select2-container--default .select2-selection--single {
        background-color: rgba(181, 130, 179, 1);
        border-color: rgba(181, 130, 179, 1);
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        color: #fff;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow b {
        border-color: #fff transparent transparent transparent;
    }

    .select2-container--default.select2-container--open .select2-selection--single .select2-selection__arrow b {
        border-color: transparent transparent #fff transparent;
    }
</style>
<div id="wrapper">
    <div id="page-wrapper" class="gray-bg" style="margin-left:0;">
        <div class="wrapper wrapper-content">
            <div class="row">
                <div class="col-md-12 animated fadeInRight">
                    <div class="mail-box-header">
                        <div class="pull" style="display:block;">
                            <div class="btn-group" style="box-shadow:none">
                                <h5 style="margin:5px;padding:0px ;display: inline-block;">出货年月*
                                </h5>
                                <select class="btn-xs btn-info active radioSelect" id="EffectiveYearNestStart"
                                    style="width:145px;height:28px;"></select>
                            </div>
                            <div class="btn-group" style="box-shadow:none">
                                <h5 style="margin:5px;padding:0px ;display: inline-block;">～
                                </h5>
                                <select class="btn-xs btn-info active radioSelect" id="EffectiveYearNestEnd"
                                    style="width:145px;height:28px;"></select>
                            </div>
                            <span class="btn btn-sm btn-white" title="点击查询" id="search_btn" onclick="search_btn()"
                                style="margin-left: 98px;"><i class="fa fa-search"></i> 查询</span>
                        </div>
                        <div class="pull" style="margin: 12px 10px 0 0;display:block;">
                            <span class="btn btn-sm btn-white" title="点击上传" id="uploadFile"><i
                                    class="fa fa-upload"></i><input type="file" onchange="upload(this)"
                                    style="width: 79px;">上传文件</span>
                            <span class="btn btn-sm btn-white" title="点击上传" id="uploadNewFile"><i
                                    class="fa fa-upload"></i><input type="file" onchange="upload(this)"
                                    style="width: 92px;">上传新文件</span>
                            <span class="btn btn-sm btn-white" title="点击下载" id="TemplateBtn"><i
                                    class="fa fa-arrow-circle-down"></i> 模版下载</span>
                            <span class="btn btn-sm btn-white" title="点击下载" id="newTemplateBtn"><i
                                    class="fa fa-arrow-circle-down"></i> 新模版下载</span>
                            <span class="btn btn-sm btn-white" title="点击删除" id="AllDeleteBtn"><i
                                    class="fa fa-trash-o"></i>
                                批量删除</span>
                            <span class="btn btn-sm btn-white" title="点击导出" id="ExportExcel"
                                onclick="ExportExcelData()"><i class="fa fa-file-excel-o"></i> 导出Excel</span>
                        </div>
                    </div>
                    <div class="mail-box">
                        <div class="mail-body">
                            <div id="example">
                                <div id="grid"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript"
    src="http://eip.unisoc.com/sites/howto/_catalogs/masterpage/jquery-ui-1.12.1/QRE/js/jquery.SPServices-2014.02.min.js"
    type="text/javascript"></script>
<script type="text/JavaScript" src="http://eip.unisoc.com/sites/howto/_catalogs/masterpage/SpreadTrumCss/spin.min.js">
</script>
<script type="text/javascript"
    src="http://eip.unisoc.com/sites/howto/_catalogs/masterpage/kendoUI/2017.3.1026/js/jszip.min.js"></script>
<script type="text/javascript"
    src="http://eip.unisoc.com/sites/howto/_catalogs/masterpage/kendoUI/2017.3.1026/js/kendo.all.min.js"></script>
<script type="text/javascript"
    src="http://eip.unisoc.com/sites/howto/_catalogs/masterpage/kendoUI/2017.3.1026/js/kendo.message.zh-CN.js"></script>
<script type="text/javascript"
    src="http://eip.unisoc.com/sites/howto/_catalogs/masterpage/kendoUI/2017.3.1026/js/kendo.culture.zh-CN.js"></script>
<script type="text/javascript"
    src="http://eip.unisoc.com/sites/howto/_catalogs/masterpage/jquery-ui-1.12.1/QRE/js/layer.js"></script>
<script type="text/javascript"
    src="http://eip.unisoc.com/sites/howto/_catalogs/masterpage/jquery-ui-1.12.1/Select2/js/select2.min.js"></script>
<script type="text/javascript">
    $(document).ready(function () {
        kendo.culture("zh-CN");
        getYearMonthSelect()
        // window.location.reload();
        search_btn()
        loadTemplate();
        allDelete();
        $(".fadeInRight").append(
            '<h4 style="color:red">* 2019年10月及以后月份请使用“新模板下载”按钮以及“上传新文件”按钮进行文件的上传以及模板的下载。</h4>')
        $('select.radioSelect').select2()
    });
    // 初始化年月下拉框
    function getYearMonthSelect() {
        var date = new Date()
        var curYearMonth = parseInt(date.format("yyyyMM"))
        for (var i = curYearMonth; i >= 201801; i--) {
            var ym = i.toString()
            var month = ym.substr(ym.length - 2)
            if (month <= 12 && month != "00") {
                document.getElementById("EffectiveYearNestStart").options.add(new Option(i, i))
                document.getElementById("EffectiveYearNestEnd").options.add(new Option(i, i))
            }
        }
        $('#EffectiveYearNestStart').val(date.getFullYear() + '01')
        $('#select2-EffectiveYearNestStart-container').html(date.getFullYear() + '01')
    }
    /*************************************************************加载表格数据*******************************************/
    function search_btn() {
        // 加载loading动画
        var index = layer.load(2, {
            offset: ['60%', "60%"],
            shade: false
        });
        //根据登录人获取数据
        //string sOwner, string sStartDate, string sEndDate
        var sOwner = $('a[id$=_Menu]').clone().children().remove().end().text();
        var sStartDate = $('#EffectiveYearNestStart').val();
        var sEndDate = $('#EffectiveYearNestEnd').val();
        $.ajaxSettings.async = false;
        $.get("http://10.0.3.52:8094/SalesDailyService.svc/GetSalesCaseList?", {
                sOwner: sOwner,
                sStartDate: sStartDate,
                sEndDate: sEndDate
            })
            .success(function (data) {
                var AllList = JSON.parse(data);
                var dataSource = new kendo.data.DataSource({
                    data: AllList,
                    schema: {
                        model: {
                            fields: {
                                id: {
                                    type: "string"
                                },
                                agency_short_name: {
                                    type: "string"
                                },
                                customer_short_name: {
                                    type: "string"
                                },
                                agency_code: {
                                    type: "number"
                                },
                                agency_name: {
                                    type: "string"
                                },
                                agency_info: {
                                    type: "string"
                                },
                                customer_code: {
                                    type: "number"
                                },
                                customer_name: {
                                    type: "string"
                                },
                                sales: {
                                    type: "string"
                                },
                                sales_department: {
                                    type: "string"
                                },
                                product_line: {
                                    type: "string"
                                },
                                sub_product_line: {
                                    type: "string"
                                },
                                qty: {
                                    type: "number"
                                },
                                sales_price: {
                                    type: "number"
                                },
                                po_price: {
                                    type: "number"
                                },
                                margin: {
                                    type: "number"
                                },
                                amount: {
                                    type: "number"
                                },
                                class1: {
                                    type: "string"
                                },
                                class2: {
                                    type: "string"
                                },
                                class3: {
                                    type: "string"
                                },
                                sap_product_id: {
                                    type: "string"
                                },
                                shipment_date: {
                                    type: "date"
                                },
                                create_time: {
                                    type: "string"
                                },
                                sales_organization: {
                                    type: "string"
                                },
                                customer_type: {
                                    type: "string"
                                },
                                current_customer_type: {
                                    type: "string"
                                },
                                calculate_customer_type: {
                                    type: "string"
                                },
                            }
                        },
                    },
                    sort: {
                        field: "create_time",
                        dir: "desc"
                    },
                    pageSize: 30
                });
                $("#grid").kendoGrid({
                    dataSource: dataSource,
                    filterable: true,
                    height: 700,
                    columnMenu: true,
                    resizable: true,
                    //pageable: true,
                    //columnMenu: true,
                    //editable: true,
                    excel: {
                        fileName: "出货报告导出" + moment().format("YYYY-MM-DD_HH：mm：ss") + ".xlsx",
                        allPages: true //是否导出所有页中的数据
                    },
                    selectable: "multiple,row",
                    sortable: true,
                    scrollable: true,
                    groupable: true,
                    pageable: {
                        refresh: true,
                    },
                    columns: [{
                            field: "id",
                            title: "序号",
                            width: 110,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "agency_short_name",
                            title: "代理简称",
                            width: 110,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "customer_short_name",
                            title: "客户简称",
                            width: 110,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "agency_code",
                            title: "代理外部号",
                            width: 120,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "agency_name",
                            title: "代理商全称",
                            width: 120,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "agency_info",
                            title: "代理商属性",
                            width: 120,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "customer_code",
                            title: "客户外部号",
                            width: 120,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "customer_name",
                            title: "客户全称",
                            width: 110,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "customer_type",
                            title: "出货月客户类别",
                            width: 150,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "current_customer_type",
                            title: "最新客户类别",
                            width: 150,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "calculate_customer_type",
                            title: "计算用客户类别",
                            width: 150,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "sales",
                            title: "销售",
                            width: 110,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "sales_department",
                            title: "销售部门",
                            width: 110,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "product_line",
                            title: "BU",
                            width: 100,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "sub_product_line",
                            title: "PDT",
                            width: 110,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "class1",
                            title: "类别一 (类型)",
                            width: 130,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "class2",
                            title: "Product Type",
                            width: 150,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "class3",
                            title: "Platform",
                            width: 130,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "sap_product_id",
                            title: "SAP物料号",
                            width: 120,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "product",
                            title: "产品型号",
                            width: 110,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "shipment_date",
                            format: "{0: yyyy-MM-dd}",
                            title: "出货日期",
                            width: 110,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "qty",
                            title: "数量",
                            width: 100,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "sales_price",
                            title: "Sales Price",
                            width: 120,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "po_price",
                            title: "PO Price",
                            width: 120,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "margin",
                            title: "margin",
                            width: 110,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "amount",
                            title: "金额",
                            width: 130,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "currency",
                            title: "币别",
                            width: 100,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "order_no",
                            title: "客户订单号",
                            width: 140,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "shipment_type",
                            title: "出货类型",
                            width: 110,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "order_month",
                            title: "订单月份",
                            width: 110,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        }, {
                            field: "shipment_company",
                            title: "发货公司",
                            width: 110,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        },
                        {
                            field: "sales_organization",
                            title: "销售组织",
                            width: 110,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        },
                        {
                            field: "comment",
                            title: "备注",
                            width: 100,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        },
                        {
                            field: "year_month",
                            title: "出货月份",
                            width: 110,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        },
                        {
                            field: "create_time",
                            title: "上传日期",
                            //format: "{0: yyyy-MM-dd hh:mm:ss}",
                            width: 180,
                            filterable: {
                                multi: true,
                                search: true
                            }
                        },
                        {
                            title: "操作",
                            command: [{
                                name: "Delete",
                                text: "Delete",
                                click: Delete
                            }],
                            width: 100,
                        }
                    ]
                });
                /*隐藏ID列*/
                //var grid = $("#grid").data("kendoGrid");
                //grid.hideColumn("id");
                //停止Loading
                layer.close(index);
            });

    }

    /*单条删除功能*/
    function Delete(e) {
        e.preventDefault();
        var tr = $(e.target).closest("tr");
        var data = this.dataItem(tr);
        var Id = data.id;
        var sOwner = $('a[id$=_Menu]').clone().children().remove().end().text();
        layer.msg('确认删除本行数据吗？', {
            icon: 7,
            skin: 'layer-ext-moon',
            time: 0,
            btn: ['是', '否'],
            yes: function (index) {
                var casedata = {
                    "ID": Id,
                    "UserName": sOwner
                };
                //根据Id 删除
                var url = "http://10.0.3.52:8094/SalesDailyService.svc/DeleteSalesCase";
                $.ajax({
                    type: "POST",
                    url: url,
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(casedata),
                    dataType: "json",
                    success: function (data) {
                        if (data == '"删除成功"') {
                            alertMessageSuccess(data + " !");
                            setTimeout(search_btn(), 2000);
                        } else {
                            alertMessage(data);
                        }
                    },
                    error: function (a, b, c) {
                        console.log(a);
                    }
                });
            }
        });
    }
    /*批量删除功能*/
    function allDelete() {
        $('#AllDeleteBtn').click(function () {
            layer.msg('确认批量删除吗？', {
                icon: 7,
                skin: 'layer-ext-moon',
                time: 0,
                btn: ['是', '否'],
                yes: function (index) {
                    var grid = $("#grid").data("kendoGrid");
                    var selectedRows = grid.select();
                    var sOwner = $('a[id$=_Menu]').clone().children().remove().end().text();
                    if (selectedRows.length < 1) {
                        alertMessage("请至少选择一条记录 !");
                        return;
                    }
                    var IdArr = new Array();
                    selectedRows.each(function (index, row) {
                        IdArr.push(grid.dataItem(row).id);
                    });
                    var param = {};
                    param.ID = IdArr.join(",");
                    param.UserName = sOwner;
                    //根据Id 删除
                    console.log("param参数值", param);
                    var url = "http://10.0.3.52:8094/SalesDailyService.svc/DeleteSalesCase";
                    $.ajax({
                        type: "POST",
                        url: url,
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(param),
                        dataType: "json",
                        success: function (data) {
                            if (data == '"删除成功"') {
                                alertMessageSuccess(data + " !");
                                setTimeout(search_btn(), 2000);
                            } else {
                                alertMessage(data);
                            }
                        },
                        error: function (a, b, c) {
                            console.log(a);
                        }
                    });
                }
            });

        });
    }

    //导出Excel功能
    function ExportExcelData() {
        $("#grid").data("kendoGrid").saveAsExcel();
    }

    /***********************************上传文件代码*******************************************************/
    /*上传附件*/
    function upload(el) {
        var flag = 1
        if ($(el)[0] == $("input[type='file']").eq(0)[0]) {
            flag = 1
        } else {
            flag = 0
        }
        //加载loading
        var index = layer.load(3);
        var serverRelativeUrlToFolder = 'SalesDataUploadList';
        var fileInput = el.files;
        if (fileInput[0].size > 30971520) {
            alertMessage("上传的文件大小不可大于30M");
            layer.close(index);
        } else {
            //文件名
            var fileNameFilter = fileInput[0].name.split('.');
            var fileType = fileNameFilter[fileNameFilter.length - 1];
            if (fileType == "xlsx") {
                var newName = fileNameFilter[0] + '-' + new Date().getTime() + '.' + fileType;
                var serverUrl = _spPageContextInfo.webAbsoluteUrl;
                //获取文件二进制
                var getFile = getFileBuffer();
                getFile.done(function (arrayBuffer) {
                    var addFile = addFileToFolder(arrayBuffer);
                    addFile.done(function (file, status, xhr) {
                        var getItem = getListItem(file.d.ListItemAllFields.__deferred.uri);
                        getItem.done(function (listItem, status, xhr) {
                            var changeItem = updateListItem(listItem.d.__metadata);
                            changeItem.done(function (data, status, xhr) {
                                //后台交互代码,返回这个文件的所在文档库的id
                                $.ajax({
                                    url: "http://eip.unisoc.com/sites/sales/_api/web/lists/getByTitle('%E5%87%BA%E8%B4%A7%E6%8A%A5%E5%91%8A%E4%B8%80%E8%A7%88')/Items?$select=ID&$filter=Title eq '" +
                                        encodeURIComponent(newName) +
                                        "'&$Top=99999999",
                                    type: "GET",
                                    async: false,
                                    headers: {
                                        "accept": "application/json;odata=verbose"
                                    },
                                    success: function (data) {
                                        var response = data.d.results;
                                        if (response) {
                                            var id = response[0].ID;
                                            $.ajaxSetup({
                                                async: false
                                            });
                                            //判断是否   是上传文件还是上传新文件
                                            if (flag) {
                                                $.get("http://10.0.3.52:8094/SalesDailyService.svc/SaveSalesImportFile?", {
                                                        sDocumentID: id
                                                    },
                                                    function (mes) {
                                                        if (mes ==
                                                            '"Success"'
                                                        ) {
                                                            alertMessage
                                                                (
                                                                    "恭喜您，文件上传成功!"
                                                                );
                                                            layer.close(
                                                                index
                                                            );
                                                            setTimeout(
                                                                search_btn(),
                                                                2500
                                                            );
                                                        } else if (
                                                            mes ==
                                                            '"NG"') {
                                                            alertMessage
                                                                (
                                                                    "校验出错: 错误文件已下载，请更正后重新上传!"
                                                                );
                                                            window
                                                                .location
                                                                .href =
                                                                "http://10.0.3.52:8094/Download/Sales/" +
                                                                encodeURIComponent(
                                                                    newName
                                                                );
                                                            layer.close(
                                                                index
                                                            );
                                                            setTimeout(
                                                                search_btn(),
                                                                2500
                                                            );
                                                        } else {
                                                            alertMessage
                                                                ("Error : " +
                                                                    mes +
                                                                    " ，请截图后联系IT工程师-John Li1 (李彦)"
                                                                );
                                                            layer.close(
                                                                index
                                                            );
                                                        }
                                                    });
                                            } else {
                                                $.get("http://10.0.3.52:8094/SalesDailyService.svc/SaveSalesImportFile_New?", {
                                                        sDocumentID: id
                                                    },
                                                    function (mes) {
                                                        if (mes ==
                                                            '"Success"'
                                                        ) {
                                                            alertMessage
                                                                (
                                                                    "恭喜您，文件上传成功!"
                                                                );
                                                            layer.close(
                                                                index
                                                            );
                                                            setTimeout(
                                                                search_btn(),
                                                                2500
                                                            );
                                                        } else if (
                                                            mes ==
                                                            '"NG"') {
                                                            alertMessage
                                                                (
                                                                    "校验出错: 错误文件已下载，请更正后重新上传!"
                                                                );
                                                            window
                                                                .location
                                                                .href =
                                                                "http://10.0.3.52:8094/Download/Sales/" +
                                                                encodeURIComponent(
                                                                    newName
                                                                );
                                                            layer.close(
                                                                index
                                                            );
                                                            setTimeout(
                                                                search_btn(),
                                                                2500
                                                            );
                                                        } else {
                                                            alertMessage
                                                                ("Error : " +
                                                                    mes +
                                                                    " ，请截图后联系IT工程师-John Li1 (李彦)"
                                                                );
                                                            layer.close(
                                                                index
                                                            );
                                                        }
                                                    });
                                            }



                                        }

                                    },
                                    error: function (xhr) {
                                        console.log(xhr.status + ': ' + xhr
                                            .statusText);
                                    }
                                });
                            });
                            changeItem.fail(onError);
                        });
                        getItem.fail(onError);
                    });
                    addFile.fail(onError);
                });
                getFile.fail(onError);
            } else {
                alertMessage("上传的文件只可以是: 以后缀.xlsx结尾的Excel文档!");
                layer.close(index);
            }
            //获取二进制文件
            function getFileBuffer() {
                var deferred = jQuery.Deferred();
                var reader = new FileReader();
                reader.onloadend = function (e) {
                    deferred.resolve(e.target.result);
                };
                reader.onerror = function (e) {
                    deferred.reject(e.target.error);
                };
                reader.readAsArrayBuffer(fileInput[0]);
                return deferred.promise();
            }
            //添加到文件夹
            function addFileToFolder(arrayBuffer) {
                var fileName = fileInput[0].name;
                var fileCollectionEndpoint = String.format(
                    "{0}/_api/web/getfolderbyserverrelativeurl('{1}')/files" +
                    "/add(overwrite=true, url='{2}')",
                    serverUrl, serverRelativeUrlToFolder, fileName);
                return jQuery.ajax({
                    url: fileCollectionEndpoint,
                    type: "POST",
                    data: arrayBuffer,
                    processData: false,
                    headers: {
                        "accept": "application/json;odata=verbose",
                        "X-RequestDigest": jQuery("#__REQUESTDIGEST").val(),
                        "content-length": arrayBuffer.byteLength
                    }
                });
            }

            function savedate(id) {
                var casedata = {
                    "DocumentID": id
                }
                var url = "http://10.0.3.52:8094/SalesDailyService.svc/SaveSalesImportFile";
                $.ajax({
                    type: "POST",
                    url: url,
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify(casedata),
                    dataType: "json",
                    success: function (data) {
                        alertMessage(data);
                    },
                    error: function (a, b, c) {
                        onsole.log(a);
                    }
                });
            }
            //获取list目录
            function getListItem(fileListItemUri) {
                return jQuery.ajax({
                    url: fileListItemUri,
                    type: "GET",
                    headers: {
                        "accept": "application/json;odata=verbose"
                    }
                });
            }
            //跟新list目录
            function updateListItem(itemMetadata) {
                var body = String.format("{{'__metadata':{{'type':'{0}'}},'FileLeafRef':'{1}','Title':'{2}'}}",
                    itemMetadata.type, newName, newName);
                return jQuery.ajax({
                    url: itemMetadata.uri,
                    type: "POST",
                    data: body,
                    headers: {
                        "X-RequestDigest": jQuery("#__REQUESTDIGEST").val(),
                        "content-type": "application/json;odata=verbose",
                        "content-length": body.length,
                        "IF-MATCH": itemMetadata.etag,
                        "X-HTTP-Method": "MERGE"
                    }
                });
            }
        }
        // $(el).replaceWith("<input type='file'  onchange='upload(this)'>");
        // console.log($(el))


    }

    //报错信息
    function onError(error) {
        alertMessage("文件上传失败，请检查网络是否正常或附件名称是否包含特殊字符");
        console.log(error.responseText)
    }

    //下载模版
    function loadTemplate() {
        $('#TemplateBtn').click(function () {
            window.location.href = "http://10.0.3.52:8094/Template/%E5%87%BA%E8%B4%A7%E6%8A%A5%E5%91%8A.xlsx";
        });
        $('#newTemplateBtn').click(function () {
            window.location.href = "http://10.0.3.52:8094/Template/出货报告_New.xlsx";
        });

    }

    //转化为base64位的
    function convertDataURIToBinary(dataURI) {
        var BASE64_MARKER = ';base64,';
        var base64Index = dataURI.indexOf(BASE64_MARKER) + BASE64_MARKER.length;
        var base64 = dataURI.substring(base64Index);
        var raw = window.atob(base64);
        var rawLength = raw.length;
        var array = new Uint8Array(new ArrayBuffer(rawLength));
        for (i = 0; i < rawLength; i++) {
            array[i] = raw.charCodeAt(i);
        }
        return array;
    }

    /*********************************************************************************************************/
    /*警告信息*/
    function alertMessage(message) {
        layer.alert(message, {
            icon: 7,
            skin: 'layer-ext-moon'
        })
    }

    function alertMessageSuccess(message) {
        layer.alert(message, {
            icon: 6,
            skin: 'layer-ext-moon'
        })
    };
</script>